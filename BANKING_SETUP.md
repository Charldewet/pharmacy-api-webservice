# Banking & Ledger Tables Setup - Step 2 Complete âœ…

This document describes the implementation of Step 2 of the PharmaSight Management Accounts financial system.

## Overview

The core banking and ledger tables have been created to support the financial management layer. This includes:

- **Bank Accounts** - Store bank account configuration per pharmacy
- **Bank Import Batches** - Track CSV uploads per bank account
- **Bank Transactions** - Store raw imported bank statement lines
- **Ledger Entries** - Single source of truth for all accounting movements

## Files Created

1. **`schema_banking.sql`** - Standalone migration file for banking and ledger tables
2. **`pharma_api/app/routers/banking.py`** - API router for bank accounts management
3. **`pharma_api/app/routers/ledger.py`** - API router for ledger entries
4. **`scripts/load_banking_tables.py`** - Python script to create and verify tables
5. **`schema.sql`** - Updated main schema file (includes banking tables)

## Database Schema

### Bank Accounts Table

```sql
CREATE TABLE pharma.bank_accounts (
  id             bigserial PRIMARY KEY,
  pharmacy_id    integer NOT NULL REFERENCES pharma.pharmacies(pharmacy_id),
  name           text NOT NULL,
  bank_name      text NOT NULL,
  account_number text,
  branch_code    text,
  currency       varchar(3) NOT NULL DEFAULT 'ZAR',
  is_active      boolean NOT NULL DEFAULT true,
  created_at     timestamptz NOT NULL DEFAULT now(),
  updated_at     timestamptz NOT NULL DEFAULT now(),
  UNIQUE (pharmacy_id, name)
);
```

### Bank Import Batches Table

```sql
CREATE TABLE pharma.bank_import_batches (
  id                bigserial PRIMARY KEY,
  bank_account_id   bigint NOT NULL REFERENCES pharma.bank_accounts(id),
  pharmacy_id       integer NOT NULL REFERENCES pharma.pharmacies(pharmacy_id),
  period_start      date,
  period_end        date,
  file_name         text NOT NULL,
  uploaded_by_user_id bigint REFERENCES pharma.users(user_id),
  uploaded_at       timestamptz NOT NULL DEFAULT now(),
  status            pharma.bank_import_status NOT NULL DEFAULT 'IMPORTED',
  notes             text
);
```

**Status Enum Values:**
- `IMPORTED` - Initial import completed
- `CLASSIFIED_PARTIAL` - Partially classified
- `CLASSIFIED_COMPLETE` - Fully classified
- `POSTED_TO_LEDGER` - Posted to ledger

### Bank Transactions Table

```sql
CREATE TABLE pharma.bank_transactions (
  id                   bigserial PRIMARY KEY,
  bank_import_batch_id bigint NOT NULL REFERENCES pharma.bank_import_batches(id),
  bank_account_id      bigint NOT NULL REFERENCES pharma.bank_accounts(id),
  pharmacy_id          integer NOT NULL REFERENCES pharma.pharmacies(pharmacy_id),
  date                 date NOT NULL,
  description          text NOT NULL,
  raw_description      text,
  reference            text,
  amount               numeric(18,2) NOT NULL,
  balance              numeric(18,2),
  raw_data             jsonb,
  external_id          text,
  created_at           timestamptz NOT NULL DEFAULT now(),
  updated_at           timestamptz NOT NULL DEFAULT now()
);
```

### Ledger Entries Table

```sql
CREATE TABLE pharma.ledger_entries (
  id                  bigserial PRIMARY KEY,
  pharmacy_id         integer NOT NULL REFERENCES pharma.pharmacies(pharmacy_id),
  date                date NOT NULL,
  description         text NOT NULL,
  amount              numeric(18,2) NOT NULL CHECK (amount > 0),
  debit_account_id    bigint NOT NULL REFERENCES pharma.accounts(id),
  credit_account_id   bigint NOT NULL REFERENCES pharma.accounts(id),
  source              pharma.ledger_source NOT NULL,
  source_reference_type text,
  source_reference_id   text,
  created_by_user_id  bigint REFERENCES pharma.users(user_id),
  created_at          timestamptz NOT NULL DEFAULT now(),
  updated_at          timestamptz NOT NULL DEFAULT now()
);
```

**Source Enum Values:**
- `PHARMASIGHT` - Generated by PharmaSight system
- `BANK` - From bank transaction classification
- `MANUAL` - Manually entered

## Setup Instructions

### Option 1: Using the Python Script (Recommended)

```bash
python scripts/load_banking_tables.py
```

This script will:
1. Create all banking and ledger tables
2. Create enum types
3. Create indexes and triggers
4. Verify everything is correctly set up

### Option 2: Using SQL Files Directly

```bash
# Create the tables
psql $DATABASE_URL -f schema_banking.sql
```

## API Endpoints

### Bank Accounts

#### Create Bank Account
```http
POST /bank-accounts
Authorization: Bearer YOUR_API_KEY

{
  "pharmacy_id": 1,
  "name": "FNB Current",
  "bank_name": "FNB",
  "account_number": "****1234",
  "branch_code": "250655",
  "currency": "ZAR",
  "is_active": true
}
```

#### List Bank Accounts for Pharmacy
```http
GET /bank-accounts/pharmacies/{pharmacy_id}?include_inactive=false
Authorization: Bearer YOUR_API_KEY
```

#### Get Bank Account
```http
GET /bank-accounts/{bank_account_id}
Authorization: Bearer YOUR_API_KEY
```

#### Update Bank Account
```http
PUT /bank-accounts/{bank_account_id}
Authorization: Bearer YOUR_API_KEY

{
  "name": "FNB Current Updated",
  "is_active": true
}
```

#### Delete Bank Account (Soft Delete)
```http
DELETE /bank-accounts/{bank_account_id}
Authorization: Bearer YOUR_API_KEY
```

### Ledger Entries

#### Create Ledger Entry
```http
POST /ledger-entries
Authorization: Bearer YOUR_API_KEY

{
  "pharmacy_id": 1,
  "date": "2025-12-15",
  "description": "Sales for December 15",
  "amount": 50000.00,
  "debit_account_id": 1010,  // Bank account
  "credit_account_id": 4000,  // Sales account
  "source": "PHARMASIGHT",
  "source_reference_type": "pharmasight_period",
  "source_reference_id": "2025-12-15"
}
```

#### List Ledger Entries for Pharmacy
```http
GET /ledger-entries/pharmacies/{pharmacy_id}?start_date=2025-12-01&end_date=2025-12-31&source=PHARMASIGHT&limit=100&offset=0
Authorization: Bearer YOUR_API_KEY
```

#### Get Ledger Entry
```http
GET /ledger-entries/{ledger_entry_id}
Authorization: Bearer YOUR_API_KEY
```

## Important Notes

### Amount Convention

- **Amounts are always stored as positive values** in `ledger_entries`
- Whether an amount increases or decreases an account depends on:
  - Account **type** (INCOME, EXPENSE, ASSET, etc.)
  - Whether it's on the **debit** or **credit** side
- For reporting, the backend P&L service will:
  - Sum debits/credits per account
  - Apply the correct sign per account type

### Bank Transaction Import

- Bank transactions are stored as raw CSV data
- Each import creates a `bank_import_batch` record
- Transactions are linked to batches via `bank_import_batch_id`
- Duplicate detection uses unique index on (`bank_account_id`, `date`, `amount`, `description`)

### Ledger Entry Sources

- **PHARMASIGHT**: Auto-generated entries from PharmaSight reports
- **BANK**: Classified bank transactions (Step 3+)
- **MANUAL**: Manually entered adjustments

## Verification

After setup, verify the tables:

```sql
-- Check tables exist
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'pharma' 
AND table_name IN ('bank_accounts', 'bank_import_batches', 'bank_transactions', 'ledger_entries');

-- Check enum types
SELECT typname, enumlabel 
FROM pg_type t 
JOIN pg_enum e ON t.oid = e.enumtypid 
WHERE typname IN ('bank_import_status', 'ledger_source')
ORDER BY typname, enumsortorder;

-- Check indexes
SELECT tablename, indexname 
FROM pg_indexes 
WHERE schemaname = 'pharma' 
AND tablename IN ('bank_accounts', 'bank_import_batches', 'bank_transactions', 'ledger_entries')
ORDER BY tablename, indexname;
```

## Next Steps

Future steps will include:
- Step 3: CSV import and bank transaction classification
- Step 4: P&L report generation from ledger entries
- Step 5: Balance sheet views

---

**Last Updated**: December 2025

